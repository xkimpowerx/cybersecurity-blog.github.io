<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ 'Edit' if article else 'New' }} Article - Cybersecurity Blog</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Cybersecurity Blog</a>
        </div>
    </nav>
    <main class="container mt-4">
        <h2>{{ 'Edit' if article else 'Add' }} Article</h2>
        <form method="post">
            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input type="text" class="form-control" id="title" name="title" required value="{{ article.title if article else '' }}">
            </div>
            <div class="mb-3">
                <label for="summary" class="form-label">Summary</label>
                <input type="text" class="form-control" id="summary" name="summary" required value="{{ article.summary if article else '' }}">
            </div>
            <div class="mb-3">
                <label for="content" class="form-label">Content</label>
                <textarea class="form-control" id="content" name="content" rows="10" required>{{ article.content if article else '' }}</textarea>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
                        <h5 class="mb-0">Images</h5>
                        <div>
                            <button type="button" class="btn btn-outline-success btn-sm" id="inlineUploadBtn">Upload & Insert Image</button>
                            <input type="file" class="d-none" id="inlineImageInput" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp,image/svg+xml">
                        </div>
                    </div>
                    <p class="text-muted small mt-2 mb-1">Upload a new image or insert one of your existing uploads directly into the content.</p>
                    <div id="uploadStatus" class="small"></div>

                    {% if uploaded_images %}
                    <div class="row g-3 mt-2" id="uploadedImages">
                        {% for image in uploaded_images %}
                        <div class="col-sm-6 col-md-4 col-lg-3">
                            <div class="border rounded p-2 text-center h-100">
                                <img src="{{ image.url }}" alt="{{ image.name }}" class="img-fluid mb-2">
                                <button type="button" class="btn btn-sm btn-outline-primary insert-image-btn w-100" data-url="{{ image.url }}">Insert Image</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mt-3 mb-0" id="uploadedImagesEmpty">No uploaded images yet. Use the button above to upload one.</p>
                    <div class="row g-3 mt-2 d-none" id="uploadedImages"></div>
                    {% endif %}
                </div>
            </div>

            <button type="submit" class="btn btn-success">Save Article</button>
            <a class="btn btn-secondary ms-2" href="/admin">Cancel</a>
        </form>
    </main>
    <script>
    (function() {
        const contentField = document.getElementById('content');
        const uploadBtn = document.getElementById('inlineUploadBtn');
        const fileInput = document.getElementById('inlineImageInput');
        const statusEl = document.getElementById('uploadStatus');
        const imagesGrid = document.getElementById('uploadedImages');
        const emptyState = document.getElementById('uploadedImagesEmpty');

        function insertAtCursor(field, text) {
            const start = field.selectionStart ?? field.value.length;
            const end = field.selectionEnd ?? field.value.length;
            const before = field.value.substring(0, start);
            const after = field.value.substring(end);
            field.value = `${before}${text}${after}`;
            const cursor = start + text.length;
            field.selectionStart = field.selectionEnd = cursor;
            field.focus();
        }

        function insertImage(url) {
            if (!contentField || !url) return;
            const snippet = `<figure class="article-image"><img src="${url}" alt=""><figcaption></figcaption></figure>`;
            insertAtCursor(contentField, snippet);
        }

        function attachInsertHandlers(root) {
            root.querySelectorAll('.insert-image-btn').forEach((btn) => {
                btn.addEventListener('click', () => insertImage(btn.dataset.url));
            });
        }

        attachInsertHandlers(document);

        function addImageCard(url) {
            if (!imagesGrid) return;
            const col = document.createElement('div');
            col.className = 'col-sm-6 col-md-4 col-lg-3';
            col.innerHTML = `
                <div class="border rounded p-2 text-center h-100">
                    <img src="${url}" alt="Uploaded image" class="img-fluid mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary insert-image-btn w-100" data-url="${url}">Insert Image</button>
                </div>
            `;
            imagesGrid.classList.remove('d-none');
            imagesGrid.appendChild(col);
            if (emptyState) {
                emptyState.classList.add('d-none');
            }
            attachInsertHandlers(col);
        }

        if (uploadBtn && fileInput) {
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                const file = fileInput.files?.[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('file', file);
                statusEl.textContent = 'Uploading image...';
                fetch('/admin/upload-image-inline', {
                    method: 'POST',
                    body: formData,
                })
                .then(async (res) => {
                    const data = await res.json();
                    if (!res.ok) {
                        throw new Error(data.error || 'Upload failed');
                    }
                    insertImage(data.image_url);
                    addImageCard(data.image_url);
                    statusEl.textContent = 'Image uploaded and inserted!';
                    fileInput.value = '';
                })
                .catch((err) => {
                    statusEl.textContent = `Error: ${err.message}`;
                })
                .finally(() => {
                    setTimeout(() => { statusEl.textContent = ''; }, 4000);
                });
            });
        }
    })();
    </script>
</body>
</html>
